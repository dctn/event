{% extends 'base.html' %}
{% load static %}

{% block body %}

    <div class="min-h-screen bg-gray-100 flex flex-col items-center p-4">

        <div class="card bg-base-100 shadow-xl rounded-2xl w-full max-w-xl p-6">

            <!-- Title -->
            <div class="text-center mb-5">
                <h1 class="text-3xl font-bold text-gray-900">QR Scanner</h1>
                <p class="text-gray-600">Scan tickets to check-in attendees.</p>
            </div>

            <!-- Scanner -->
            <div id="reader" class="w-full rounded-xl overflow-hidden shadow-lg"></div>

            <!-- Loading -->
            <p id="loadingMsg" class="text-gray-500 text-center mt-3">
                Initializing camera...
            </p>

            <!-- Result Box -->
            <div id="resultBox" class="hidden mt-5">
                <div id="resultCard" class="alert text-lg font-semibold p-4"></div>
            </div>

            <!-- Scan Again -->
            <button id="scanAgainBtn"
                    class="btn btn-outline w-full mt-4 hidden"
                    onclick="resumeScanner()">
                Scan Next Ticket
            </button>

        </div>


    <button id="switchCameraBtn" onclick="switchCamera()" class="btn btn-outline mt-3">ðŸ”„ Switch Camera</button>


    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>

<script>
    const reader = new Html5Qrcode("reader");

    let isScanning = false;
    let cameras = [];
    let currentCameraIndex = 0;

    async function startScanner() {
        console.log("Starting scanner...");
        document.getElementById("loadingMsg").classList.remove("hidden");

        cameras = await Html5Qrcode.getCameras();

        if (!cameras || cameras.length === 0) {
            document.getElementById("loadingMsg").innerText = "âŒ No camera found";
            return;
        }

        // ðŸ”¥ Auto-pick BACK camera first
        currentCameraIndex = cameras.findIndex(cam =>
            cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("rear") ||
            cam.label.toLowerCase().includes("environment")
        );

        // Fallback (iOS / unknown labels)
        if (currentCameraIndex === -1) {
            currentCameraIndex = cameras.length - 1;
        }

        await startWithCamera(cameras[currentCameraIndex].id);
    }

    async function startWithCamera(cameraId) {
        try {
            await reader.start(
                cameraId,
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => handleScan(decodedText),
                () => {}
            );

            isScanning = true;
            document.getElementById("loadingMsg").classList.add("hidden");
            console.log("Camera started:", cameraId);
        } catch (err) {
            console.error("Camera start error:", err);
        }
    }

    async function stopScanner() {
        if (isScanning) {
            await reader.stop();
            isScanning = false;
            console.log("Scanner stopped");
        }
    }

    async function switchCamera() {
        if (cameras.length < 2) {
            alert("Only one camera available");
            return;
        }

        await stopScanner();

        // ðŸ”„ Toggle camera index
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;

        console.log("Switching to camera:", cameras[currentCameraIndex].label);
        startWithCamera(cameras[currentCameraIndex].id);
    }

    function resumeScanner() {
        document.getElementById("resultBox").classList.add("hidden");
        document.getElementById("scanAgainBtn").classList.add("hidden");
        startScanner();
    }

    async function handleScan(decodedText) {
        await stopScanner();
        console.log("ðŸ“Œ SCANNED:", decodedText);

        // Validate URL
        try {
            new URL(decodedText);
        } catch {
            showResult("alert alert-error", "âŒ Invalid QR code");
            document.getElementById("scanAgainBtn").classList.remove("hidden");
            return;
        }

        try {
            const response = await fetch(decodedText, {
                method: "GET",
                headers: { "Accept": "text/plain" }
            });

            const text = await response.text();
            console.log("Server response:", text);

            if (text.includes("CHECKIN_SUCCESS")) {
                showResult("alert alert-success", "âœ… Ticket Check-In Successful!");
            } else if (text.includes("ALREADY_CHECKED_IN")) {
                showResult("alert alert-warning", "âš ï¸ Already Checked-In");
            } else if (text.includes("INVALID_TICKET")) {
                showResult("alert alert-error", "âŒ Invalid Ticket");
            } else {
                showResult("alert alert-error", "âŒ Unknown response");
            }

        } catch (err) {
            console.error(err);
            showResult("alert alert-error", "âŒ Network error");
        }

        document.getElementById("scanAgainBtn").classList.remove("hidden");
    }

    function showResult(cssClass, message) {
        const box = document.getElementById("resultBox");
        const card = document.getElementById("resultCard");

        box.classList.remove("hidden");
        card.className = cssClass;
        card.innerHTML = message;
    }

    // ðŸš€ Auto start
    startScanner();
</script>



{% endblock %}
